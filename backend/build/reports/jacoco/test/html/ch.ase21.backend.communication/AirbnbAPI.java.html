<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AirbnbAPI.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">ch.ase21.backend.communication</a> &gt; <span class="el_source">AirbnbAPI.java</span></div><h1>AirbnbAPI.java</h1><pre class="source lang-java linenums">package ch.ase21.backend.communication;

import ch.ase21.backend.entity.Airbnb;
import ch.ase21.backend.entity.Coordinates;
import com.fasterxml.jackson.databind.JsonNode;

import java.io.*;
import java.net.HttpURLConnection;
import java.util.*;

public class AirbnbAPI extends GraphqlAPI {

  private static final String API_URL = &quot;http://airbnbapi:8080/graphql&quot;;

  private static final String PROPERTY_FIELDS =
      &quot;id\n&quot; +
      &quot;name\n&quot; +
      &quot;hostId\n&quot; +
      &quot;hostName\n&quot; +
      &quot;neighbourhoodGroup\n&quot; +
      &quot;neighbourhood\n&quot; +
      &quot;latitude\n&quot; +
      &quot;longitude\n&quot; +
      &quot;roomType\n&quot; +
      &quot;price\n&quot; +
      &quot;minimumNights\n&quot; +
      &quot;numberOfReviews\n&quot; +
      &quot;lastReview\n&quot; +
      &quot;reviewsPerMonth\n&quot; +
      &quot;calculatedHostListingsCount\n&quot; +
      &quot;availability365\n&quot;;


  private AirbnbAPI() {/* void */}

  /**
   * Takes a JsonNode representing an airbnb property and returns the property with all fields in the json node.
   * The JsonNode must contain all fields of an airbnb property.
   * @param node A JsonNode with all fields of an airbnb property.
   * @return The airbnb property.
   */
  private static Airbnb getAirbnbFromNode(JsonNode node){
<span class="nc" id="L43">    String propertyId = node.get(&quot;id&quot;).asText();</span>
<span class="nc" id="L44">    String name = node.get(&quot;name&quot;).asText();</span>
<span class="nc" id="L45">    Integer hostId = node.get(&quot;hostId&quot;).intValue();</span>
<span class="nc" id="L46">    String hostName = node.get(&quot;hostName&quot;).asText();</span>
<span class="nc" id="L47">    String neighbourhoodGroup = node.get(&quot;neighbourhoodGroup&quot;).asText();</span>
<span class="nc" id="L48">    String neighbourhood = node.get(&quot;neighbourhood&quot;).asText();</span>
<span class="nc" id="L49">    Float latitude = node.get(&quot;latitude&quot;).floatValue();</span>
<span class="nc" id="L50">    Float longitude = node.get(&quot;longitude&quot;).floatValue();</span>
<span class="nc" id="L51">    String roomType = node.get(&quot;roomType&quot;).asText();</span>
<span class="nc" id="L52">    Integer price = node.get(&quot;price&quot;).intValue();</span>
<span class="nc" id="L53">    Integer minimumNights = node.get(&quot;minimumNights&quot;).intValue();</span>
<span class="nc" id="L54">    Integer numberOfReviews = node.get(&quot;numberOfReviews&quot;).intValue();</span>
<span class="nc" id="L55">    String lastReview = node.get(&quot;lastReview&quot;).asText();</span>
<span class="nc" id="L56">    Integer reviewsPerMonth = node.get(&quot;reviewsPerMonth&quot;).intValue();</span>
<span class="nc" id="L57">    Integer calculatedHostListingsCount = node.get(&quot;calculatedHostListingsCount&quot;).intValue();</span>
<span class="nc" id="L58">    Integer availability365 = node.get(&quot;availability365&quot;).intValue();</span>

<span class="nc" id="L60">    return new Airbnb(</span>
        propertyId,
        name,
        hostId,
        hostName,
        neighbourhoodGroup,
        neighbourhood,
        latitude,
        longitude,
        roomType,
        price,
        minimumNights,
        numberOfReviews,
        lastReview,
        reviewsPerMonth,
        calculatedHostListingsCount,
        availability365
    );
  }

  /**
   * Get all coordinates of the airbnb properties as Coordinate objects.
   * @return List of all coordinates.
   * @throws IOException Thrown if the communication with the API failed.
   */
  public static List&lt;Coordinates&gt; getAllCoordinates() throws IOException{
<span class="nc" id="L86">    HttpURLConnection connection = setupConnection(API_URL);</span>
<span class="nc" id="L87">    String query =</span>
        &quot;{\n&quot; +
          &quot;allProperties {\n&quot; +
            &quot;id\n&quot; +
            &quot;latitude\n&quot; +
            &quot;longitude\n&quot; +
          &quot;}\n&quot; +
        &quot;}&quot;;
<span class="nc" id="L95">    insertQuery(connection, query);</span>
<span class="nc" id="L96">    JsonNode responseData = getResponseData(connection);</span>
<span class="nc" id="L97">    Iterator&lt;JsonNode&gt; nodes = responseData.get(&quot;allProperties&quot;).elements();</span>
<span class="nc" id="L98">    List&lt;Coordinates&gt; properties = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L99">    nodes.forEachRemaining(node -&gt; {</span>
<span class="nc" id="L100">      String id = node.get(&quot;id&quot;).asText();</span>
<span class="nc" id="L101">      Float latitude = node.get(&quot;latitude&quot;).floatValue();</span>
<span class="nc" id="L102">      Float longitude = node.get(&quot;longitude&quot;).floatValue();</span>
<span class="nc" id="L103">      properties.add(new Coordinates(id, latitude, longitude));</span>
<span class="nc" id="L104">    });</span>
<span class="nc" id="L105">    return properties;</span>
  }

  /**
   * Get an airbnb property by its ID.
   * @param id The id of the airbnb property.
   * @return The Airbnb object.
   * @throws IOException Thrown if the communication with the API failed.
   */
  public static Airbnb getById(String id) throws IOException{
<span class="nc" id="L115">    HttpURLConnection connection = setupConnection(API_URL);</span>
<span class="nc" id="L116">    String query =</span>
        &quot;{\n&quot; +
          &quot;propertyById(id: \&quot;&quot; + id + &quot;\&quot;) {\n&quot; +
            PROPERTY_FIELDS +
          &quot;}\n&quot; +
        &quot;}&quot;;
<span class="nc" id="L122">    insertQuery(connection, query);</span>
<span class="nc" id="L123">    JsonNode responseData = getResponseData(connection);</span>
<span class="nc" id="L124">    JsonNode node = responseData.get(&quot;propertyById&quot;);</span>
<span class="nc" id="L125">    return getAirbnbFromNode(node);</span>
  }

  /**
   * Get all airbnb properties in the given neighbourhood.
   * @param neighbourhood The neighbourhood name.
   * @return The List of all airbnb properties in the neighbourhood.
   * @throws IOException Thrown if the communication with the API failed.
   */
  public static List&lt;Airbnb&gt; getAllByNeighbourhood(String neighbourhood) throws IOException{
<span class="nc" id="L135">    HttpURLConnection connection = setupConnection(API_URL);</span>
<span class="nc" id="L136">    String query =</span>
        &quot;{\n&quot; +
          &quot;propertiesByNeighbourhood(neighbourhood:\&quot;&quot; + neighbourhood + &quot;\&quot;) {\n&quot; +
            PROPERTY_FIELDS +
          &quot;}\n&quot; +
        &quot;}&quot;;
<span class="nc" id="L142">    insertQuery(connection, query);</span>
<span class="nc" id="L143">    JsonNode responseData = getResponseData(connection);</span>
<span class="nc" id="L144">    Iterator&lt;JsonNode&gt; nodes = responseData.get(&quot;propertiesByNeighbourhood&quot;).elements();</span>
<span class="nc" id="L145">    List&lt;Airbnb&gt; properties = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L146">    nodes.forEachRemaining(node -&gt; properties.add(getAirbnbFromNode(node)));</span>
<span class="nc" id="L147">    return properties;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>